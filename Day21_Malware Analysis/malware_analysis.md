## Day 21 – Malware Analysis (HTA Files)

### Scenario Overview

In Wareville, the TBFC SOC team noticed several elves’ machines behaving suspiciously. The common link was an email containing a “salary survey” attachment in **HTA format**. Although HTA files are commonly used for legitimate automation tasks, King Malhare had weaponised one to gain access, execute hidden scripts, and exfiltrate system information.

The task was to analyse the HTA safely, understand its behaviour, and uncover how it was being used maliciously.

---

### My Role

I acted as a **SOC Analyst / Junior Malware Analyst**, responsible for performing **static analysis** on a suspicious HTA file. My goal was to understand what the file claimed to do, what it actually did behind the scenes, and identify indicators of malicious activity such as obfuscation, external communication, and data exfiltration.

---

### Tools Used

* Text editor (Pluma)
* CyberChef
* Static code analysis
* Basic malware analysis techniques
* Windows scripting knowledge (VBScript & PowerShell)

---

### Investigative Approach

1. **Safe Inspection**
   I opened the HTA file using a text editor instead of executing it to prevent accidental code execution.

2. **Metadata Review**
   I examined the `<head>` and `<HTA:APPLICATION>` sections to understand how the application presented itself to users.

3. **Script Analysis**
   I located the `<script type="text/vbscript">` section and identified key functions that executed automatically when the file was opened.

4. **Function & Logic Tracing**
   I traced how data flowed through functions, focusing on:

   * External requests
   * Encoded strings
   * Execution of downloaded content

5. **Deobfuscation**
   I extracted encoded strings and used CyberChef to decode Base64 and ROT13 layers.

6. **Exfiltration Identification**
   I identified what data was being collected from the host and where it was being sent.

---

### Key Findings

* The HTA masqueraded as a **developer salary survey**.
* It used **VBScript** to automatically execute on launch.
* Survey questions were downloaded from a **typosquatted domain**.
* The downloaded content was **executed**, not just displayed.
* System information (computer name and username) was collected.
* Data was exfiltrated via an HTTP GET request.
* Payloads were obfuscated using **Base64** and **ROT13**.
* PowerShell was used to execute code in memory.

---

### Useful Commands & Analysis Actions

| Purpose               | Tool / Command / Action         | Explanation                                         |
| --------------------- | ------------------------------- | --------------------------------------------------- |
| Open HTA safely       | `pluma survey.hta`              | Prevents accidental execution while inspecting code |
| Identify metadata     | `<HTA:APPLICATION>` tag         | Reveals how the app presents itself                 |
| Find execution logic  | `<script type="text/vbscript">` | Contains malicious logic                            |
| Detect auto‑execution | `window_onLoad()`               | Runs immediately when HTA opens                     |
| Locate downloads      | `getQuestions()`                | Fetches external content                            |
| Identify execution    | `runObject.Run`                 | Executes downloaded PowerShell code                 |
| Decode Base64         | CyberChef → From Base64         | Reveals hidden URLs or scripts                      |
| Decrypt ROT13         | CyberChef → ROT13               | Reverses simple obfuscation                         |
| Identify exfiltration | HTTP GET to `/details`          | Sends stolen system data                            |
| Enumerated data       | `WScript.Network`               | Extracts ComputerName & UserName                    |

---

### Encoding & Obfuscation Concepts (Brief)

* **Base64**:
  An encoding method used to represent binary data in text form. Commonly abused to hide URLs or scripts.

* **ROT13**:
  A simple letter substitution cipher shifting characters by 13 positions. Easy to reverse but effective against casual inspection.

* **Obfuscation**:
  Techniques used to make code harder to read and analyse, often layered to delay detection.

---

### Outcome

The analysis confirmed that the HTA file was **malicious**, performing disguised data collection and executing obfuscated PowerShell payloads. This exercise demonstrated how attackers abuse trusted file formats and basic encoding techniques to evade detection and compromise systems.

---

### Skills & Concepts Learned

* Static malware analysis of HTA files
* Identifying malicious VBScript logic
* Detecting social engineering in malware
* Using CyberChef for decoding and deobfuscation
* Understanding data exfiltration techniques
* Recognising living‑off‑the‑land tactics

---
